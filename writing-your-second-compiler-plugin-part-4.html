<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Writing Your Second Kotlin Compiler Plugin, Part 4 ‚Äî Building Kotlin IR ¬∑ Dev Blog by Brian</title> <meta name="description" content=" At the time of writing this article, Kotlin compatibility for IR backend is in Alpha status andthe compiler plugin API is Experimental. As such, informatio..."> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4"> <link rel="alternate" type="application/atom+xml" title="Dev Blog by Brian" href="https://blog.bnorm.dev/feed.xml" /> <!-- OpenGraph metadatas --> <meta name="og:type" content="article"> <meta name="og:site_name" content="Dev Blog by Brian"> <meta name="og:title" content="Writing Your Second Kotlin Compiler Plugin, Part 4 ‚Äî Building Kotlin IR"> <meta name="og:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4"> <meta name="og:description" content="Building Kotlin IR"> <!-- Twitter cards metadatas --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@bnormcodes"> <meta name="twitter:creator" content="@bnormcodes"> <meta name="twitter:title" content="Writing Your Second Kotlin Compiler Plugin, Part 4 ‚Äî Building Kotlin IR"> <meta name="twitter:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4"> <meta name="twitter:description" content="Building Kotlin IR"> <!-- Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Writing Your Second Kotlin Compiler Plugin, Part 4 ‚Äî Building Kotlin IR</h1> <time class="code">December 12, 2020</time> </div> <div class="divider"></div> <blockquote> <p>At the time of writing this article, <a href="https://kotlinlang.org/docs/reference/evolution/components-stability.html">Kotlin compatibility</a> for IR backend is in Alpha status and the compiler plugin API is Experimental. As such, information contained in this article about IR and compiler plugins could be out-of-date or incorrect. If official documentation exists, please refer to it first.</p> </blockquote> <p>Now that we know how to navigate Kotlin IR from <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3">Part 3</a>, we can start talking about how to transform Kotlin IR, right? Well we have one more topic we need to cover first: building Kotlin IR. Transforming Kotlin IR works by adding, removing, or replacing IR elements, so we need to know how to build them first!</p> <ul> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1">Part 1 - Project Setup</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-2">Part 2 - Inspecting Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3">Part 3 - Navigating Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4">Part 4 - Building Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5">Part 5 - Transforming Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6">Part 6 - Support Libraries, Publishing, and Integration Testing</a></li> </ul> <h1 id="building-context">Building Context</h1> <p>Back in <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1">Part 1</a> we learned about the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrGenerationExtension.kt">IrGenerationExtension</a> interface which is the entry point for a compiler plugin to generate or transform Kotlin IR. We talked briefly about the <code class="language-plaintext highlighter-rouge">IrModuleFragment</code> parameter in <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-2">Part 2</a>, but now we need to talk about the other parameter, <code class="language-plaintext highlighter-rouge">IrPluginContext</code>. A <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrPluginContext.kt">IrPluginContext</a> provides contextual information to the plugin about things outside the current module being compiled.</p> <p>From the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrPluginContext.kt">IrPluginContext</a> instance, we can obtain an instance of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt">IrFactory</a>. This factory class is how a Kotlin compiler plugin can create its own IR elements. It contains many functions for building instances of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt#L28">IrClass</a>, <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt#L89">IrSimpleFunction</a>, <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt#L136">IrProperty</a>, and much more. But probably more important, there are also quite a few <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/ir/builders/declarations/declarationBuilders.kt">extension functions</a> which make building IR declarations easier.</p> <p><a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt">IrFactory</a> is useful when building declarations: classes, functions, properties, etc, but when building statements and expressions, you will need an instance of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L31">IrBuilder</a>. More importantly, you will need an instance of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L37">IrBuilderWithScope</a>. With this builder instance, a lot more <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/ExpressionHelpers.kt">extension functions</a> for IR expressions become available.</p> <h1 id="hello-world-but-make-it-ir">Hello World, But Make It IR</h1> <p>Some of this might make more sense when shown an example, so let‚Äôs build the following with IR!</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">println</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>But how do we know what to build? Remember our friend <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-2"><code class="language-plaintext highlighter-rouge">dump()</code> from Part 2</a>? Using that utility we can dump the IR tree for the above example.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FUN name:main visibility:public modality:FINAL &lt;&gt; () returnType:kotlin.Unit
  BLOCK_BODY
    CALL 'public final fun println (message: kotlin.Any?): kotlin.Unit [inline] declared in kotlin.io.ConsoleKt' type=kotlin.Unit origin=null
      message: CONST String type=kotlin.String value="Hello, World!"
</code></pre></div></div> <p>From this we have a blueprint for what to build! Let‚Äôs take a look at different sections of the resulting code and then put the whole thing together.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">typeNullableAny</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">anyNType</span>
<span class="kd">val</span> <span class="py">typeUnit</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">unitType</span>
</code></pre></div></div> <p>From the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrPluginContext.kt">IrPluginContext</a> you can get an instance of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/descriptors/IrBuiltIns.kt">IrBuiltIns</a> which provides quick access to many things built into the Kotlin language. This includes references to many class types and IR symbols. Here we are getting the types <code class="language-plaintext highlighter-rouge">Any?</code> and <code class="language-plaintext highlighter-rouge">Unit</code> as instances of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/types/IrType.kt">IrType</a>. These will be used later to find the correct <code class="language-plaintext highlighter-rouge">println</code> overload and set the return type of the <code class="language-plaintext highlighter-rouge">main</code> function.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">funPrintln</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceFunctions</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.io.println"</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">single</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">parameters</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">valueParameters</span>
    <span class="n">parameters</span><span class="p">.</span><span class="n">size</span> <span class="p">==</span> <span class="mi">1</span> <span class="p">&amp;&amp;</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="p">==</span> <span class="n">typeNullableAny</span>
  <span class="p">}</span>
</code></pre></div></div> <p>If what you need isn‚Äôt built into the language itself, but rather comes from a dependency (like the standard library), you can use the <code class="language-plaintext highlighter-rouge">IrPluginContext.reference*()</code> functions to find the needed <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/symbols/IrSymbol.kt#L27">IrSymbol</a>. An <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/symbols/IrSymbol.kt#L27">IrSymbol</a> allows for a lazy reference to an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L23">IrElement</a>, and as such it has a property <code class="language-plaintext highlighter-rouge">owner</code> which links to the referenced <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L23">IrElement</a>. Here we are getting the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/symbols/IrSymbol.kt#L93">IrFunctionSymbol</a> for the <code class="language-plaintext highlighter-rouge">println(message: Any?)</code> function.</p> <p>Since function overloading is supported in Kotlin, there can be multiple functions with the same fully-qualified name, so we need to filter the returned functions to a single function with the desired signature.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">funMain</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irFactory</span><span class="p">.</span><span class="nf">buildFun</span> <span class="p">{</span>
  <span class="n">name</span> <span class="p">=</span> <span class="nc">Name</span><span class="p">.</span><span class="nf">identifier</span><span class="p">(</span><span class="s">"main"</span><span class="p">)</span>
  <span class="n">visibility</span> <span class="p">=</span> <span class="nc">DescriptorVisibilities</span><span class="p">.</span><span class="nc">PUBLIC</span> <span class="c1">// default</span>
  <span class="n">modality</span> <span class="p">=</span> <span class="nc">Modality</span><span class="p">.</span><span class="nc">FINAL</span> <span class="c1">// default</span>
  <span class="n">returnType</span> <span class="p">=</span> <span class="n">typeUnit</span>
<span class="p">}</span>
</code></pre></div></div> <p>Using the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFactory.kt">IrFactory</a> instance from the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrPluginContext.kt">IrPluginContext</a> we can build a function using the extension function <code class="language-plaintext highlighter-rouge">buildFun</code>. This function takes a lambda with receiver of type <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/declarations/IrFunctionBuilder.kt">IrFunctionBuilder</a> which allows for setting various properties like name, visibility, modality, and the return type, all of which we are setting here even though some have default values.</p> <p>You do not need to set a body as part of building the initial function definition. This is because not all functions have bodies! Kotlin has many cases when a function body isn‚Äôt required like <code class="language-plaintext highlighter-rouge">abstract</code> and <code class="language-plaintext highlighter-rouge">expect</code> function definitions.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">funMain</span><span class="p">.</span><span class="n">body</span> <span class="p">=</span> <span class="nc">DeclarationIrBuilder</span><span class="p">(</span><span class="n">pluginContext</span><span class="p">,</span> <span class="n">funMain</span><span class="p">.</span><span class="n">symbol</span><span class="p">).</span><span class="nf">irBlockBody</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">callPrintln</span> <span class="p">=</span> <span class="nf">irCall</span><span class="p">(</span><span class="n">funPrintln</span><span class="p">)</span>
  <span class="n">callPrintln</span><span class="p">.</span><span class="nf">putValueArgument</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">irString</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">))</span>
  <span class="p">+</span><span class="n">callPrintln</span>
<span class="p">}</span>
</code></pre></div></div> <p>If you do want to add a body to the function you can do so by setting the <code class="language-plaintext highlighter-rouge">body</code> property of the built <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFunction.kt#L31">IrFunction</a>. To do so you will need an instance of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L37">IrBuilderWithScope</a> which is created here as a <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/lower/LowerUtils.kt#L42">DeclarationIrBuilder</a>. From this builder you will have access to <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/ExpressionHelpers.kt">many builder extension functions</a> including the <code class="language-plaintext highlighter-rouge">irBlockBody</code> function used here. The <code class="language-plaintext highlighter-rouge">irBlockBody</code> takes a lambda with receiver of type <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L58">IrBlockBodyBuilder</a> which is also a <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L37">IrBuilderWithScope</a> allowing other builder extension functions to be used.</p> <p>From within an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L58">IrBlockBodyBuilder</a>, a function call can be created via the <code class="language-plaintext highlighter-rouge">irCall</code> function and a string constant can be created via the <code class="language-plaintext highlighter-rouge">irString</code> function. Combine these together to create a call to <code class="language-plaintext highlighter-rouge">println</code> with the parameter value <code class="language-plaintext highlighter-rouge">"Hello, World!"</code>. This function call can be added to the surrounding block body using the <code class="language-plaintext highlighter-rouge">+</code> operator on the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrCall.kt#L22">IrCall</a>. Otherwise we would have created the function call but not put it anywhere!</p> <p>Putting all these sections together, and using the <code class="language-plaintext highlighter-rouge">also</code> scoping function to remove temporary local variables, will result in the following. This example should print out a dump of the built IR which is exactly the same as what we started with; success!</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">generate</span><span class="p">(</span><span class="n">moduleFragment</span><span class="p">:</span> <span class="nc">IrModuleFragment</span><span class="p">,</span> <span class="n">pluginContext</span><span class="p">:</span> <span class="nc">IrPluginContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">typeNullableAny</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">anyNType</span>
  <span class="kd">val</span> <span class="py">typeUnit</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">unitType</span>

  <span class="kd">val</span> <span class="py">funPrintln</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceFunctions</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.io.println"</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">single</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">parameters</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">valueParameters</span>
      <span class="n">parameters</span><span class="p">.</span><span class="n">size</span> <span class="p">==</span> <span class="mi">1</span> <span class="p">&amp;&amp;</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="p">==</span> <span class="n">typeNullableAny</span>
    <span class="p">}</span>

  <span class="kd">val</span> <span class="py">funMain</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irFactory</span><span class="p">.</span><span class="nf">buildFun</span> <span class="p">{</span>
    <span class="n">name</span> <span class="p">=</span> <span class="nc">Name</span><span class="p">.</span><span class="nf">identifier</span><span class="p">(</span><span class="s">"main"</span><span class="p">)</span>
    <span class="n">visibility</span> <span class="p">=</span> <span class="nc">DescriptorVisibilities</span><span class="p">.</span><span class="nc">PUBLIC</span> <span class="c1">// default</span>
    <span class="n">modality</span> <span class="p">=</span> <span class="nc">Modality</span><span class="p">.</span><span class="nc">FINAL</span> <span class="c1">// default</span>
    <span class="n">returnType</span> <span class="p">=</span> <span class="n">typeUnit</span>
  <span class="p">}.</span><span class="nf">also</span> <span class="p">{</span> <span class="n">function</span> <span class="p">-&gt;</span>
    <span class="n">function</span><span class="p">.</span><span class="n">body</span> <span class="p">=</span> <span class="nc">DeclarationIrBuilder</span><span class="p">(</span><span class="n">pluginContext</span><span class="p">,</span> <span class="n">function</span><span class="p">.</span><span class="n">symbol</span><span class="p">).</span><span class="nf">irBlockBody</span> <span class="p">{</span>
      <span class="p">+</span><span class="nf">irCall</span><span class="p">(</span><span class="n">funPrintln</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
        <span class="n">call</span><span class="p">.</span><span class="nf">putValueArgument</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">irString</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">println</span><span class="p">(</span><span class="n">funMain</span><span class="p">.</span><span class="nf">dump</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div></div> <h1 id="origin-story">Origin Story</h1> <p>The pattern of dumping Kotlin IR and recreating is the pattern I most often use when attempting to create IR elements. However, sometimes it doesn‚Äôt work so well. For example, consider the following data class.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Person</span><span class="p">(</span>
  <span class="kd">val</span> <span class="py">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
  <span class="kd">val</span> <span class="py">age</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
  <span class="kd">val</span> <span class="py">email</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>
</code></pre></div></div> <p>If you dump the IR tree for this class it is 181 lines long! Because of all the code generation that happens behind a data class, it becomes difficult to manually generate efficiently. All of this generation takes place during the conversion between the compiler frontend (PSI/FIR) to the compiler backend (IR). However, it does hint at something which can be useful so let‚Äôs take a look at a small section of the IR dump.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FUN GENERATED_DATA_CLASS_MEMBER name:component1 visibility:public modality:FINAL &lt;&gt; ($this:&lt;root&gt;.Person) returnType:kotlin.String [operator]
  $this: VALUE_PARAMETER name:&lt;this&gt; type:&lt;root&gt;.Person
  BLOCK_BODY
    RETURN type=kotlin.Nothing from='public final fun component1 (): kotlin.String [operator] declared in &lt;root&gt;.Person'
      GET_FIELD 'FIELD PROPERTY_BACKING_FIELD name:name type:kotlin.String visibility:private [final]' type=kotlin.String origin=null
        receiver: GET_VAR '&lt;this&gt;: &lt;root&gt;.Person declared in &lt;root&gt;.Person.component1' type=&lt;root&gt;.Person origin=null
</code></pre></div></div> <p>This is the IR for the generated <code class="language-plaintext highlighter-rouge">fun component1(): String</code> function of the data class which will return the name of the person. Notice the big <code class="language-plaintext highlighter-rouge">GENERATED_DATA_CLASS_MEMBER</code> text right near the beginning of the dump? This is the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrDeclarationOrigin.kt#L19">IrDeclarationOrigin</a> property of the function that all <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrDeclaration.kt#L37">IrDeclaration</a> elements have. The origin of a declaration describes what Kotlin source code construct compilation resulted in that particular declaration. In our example, this function originated from a data class.</p> <p>There is also a <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrStatementOrigin.kt#L23">IrStatementOrigin</a> class which is the same for many different subtypes of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L37">IrStatement</a> which includes the likes of <code class="language-plaintext highlighter-rouge">DO_WHILE_LOOP</code>, <code class="language-plaintext highlighter-rouge">ELVIS</code>, and <code class="language-plaintext highlighter-rouge">RANGE</code>. From these types, and if you have the Kotlin source code opened with IntelliJ, you can navigate to the code which generates the IR code for corresponding construct. For example, if you search for <code class="language-plaintext highlighter-rouge">DO_WHILE_LOOP</code>, you will find the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.psi2ir/src/org/jetbrains/kotlin/psi2ir/generators/LoopExpressionGenerator.kt#L55">LoopExpressionGenerator</a> class which has a function called <code class="language-plaintext highlighter-rouge">generateDoWhileLoop</code> which can generate a do-while loop <code class="language-plaintext highlighter-rouge">IrExpression</code> from a <code class="language-plaintext highlighter-rouge">KtDoWhileExpression</code>.</p> <p>If you are attempting to build an IR element and do not know what functions to call to build it, often the easiest thing is to search the Kotlin compiler for examples of similar IR elements. Having a local instance of the Kotlin repository which has been indexed by IntelliJ is very import since there is no official documentation for a compiler plugin API.</p> <hr /> <p>Hopefully this article provided you with a good foundation for building IR elements. If you are struggling with the concepts of code generation in general, you might want to check out something like <a href="https://square.github.io/kotlinpoet/">KotlinPoet</a> which generates Kotlin source code instead of IR and is extremely well documented. Since <a href="https://square.github.io/kotlinpoet/">KotlinPoet</a> generates text output it is also easier to experiment with different However, if you want to jump feet first into building some Kotlin IR elements, check out my <a href="https://github.com/bnorm/kotlin-ir-plugin-template">GitHub template</a> project for IR based Kotlin compiler plugins!</p> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">Part 4 is ready! We&#39;re slowly building up to transforming Kotlin IR, but we need a quick detour! üèóÔ∏è <a href="https://t.co/LByr8c21aZ">https://t.co/LByr8c21aZ</a></p>&mdash; Brian Norman üê¢ (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1337824700270080008?ref_src=twsrc%5Etfw">December 12, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="next" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5" title="NEXT: Writing Your Second Kotlin Compiler Plugin, Part 5 ‚Äî Transforming Kotlin IR">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3" title="PREV: Writing Your Second Kotlin Compiler Plugin, Part 3 ‚Äî Navigating Kotlin IR">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2020 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
