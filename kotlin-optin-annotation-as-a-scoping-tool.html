<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Kotlin OptIn Annotation as a Scoping Tool ¬∑ Dev Blog by Brian</title> <meta name="description" content="I like to follow the kotlinx.coroutines library closely on GitHub. Not really because I haveanything to contribute, but because there is so much to learn!"> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/kotlin-optin-annotation-as-a-scoping-tool"> <link rel="alternate" type="application/atom+xml" title="Dev Blog by Brian" href="https://blog.bnorm.dev/feed.xml" /> <!-- OpenGraph metadatas --> <meta name="og:type" content="article"> <meta name="og:site_name" content="Dev Blog by Brian"> <meta name="og:title" content="Kotlin OptIn Annotation as a Scoping Tool"> <meta name="og:url" content="https://blog.bnorm.dev/kotlin-optin-annotation-as-a-scoping-tool"> <meta name="og:description" content="Kotlin OptIn Annotation as a Scoping Tool"> <!-- Twitter cards metadatas --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@bnormcodes"> <meta name="twitter:creator" content="@bnormcodes"> <meta name="twitter:title" content="Kotlin OptIn Annotation as a Scoping Tool"> <meta name="twitter:url" content="https://blog.bnorm.dev/kotlin-optin-annotation-as-a-scoping-tool"> <meta name="twitter:description" content="Kotlin OptIn Annotation as a Scoping Tool"> <!-- Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Kotlin OptIn Annotation as a Scoping Tool</h1> <time class="code">May 23, 2020</time> </div> <div class="divider"></div> <p>I like to follow the <a href="https://github.com/Kotlin/kotlinx.coroutines"><code class="language-plaintext highlighter-rouge">kotlinx.coroutines</code></a> library closely on GitHub. Not really because I have anything to contribute, but because there is so much to learn!</p> <p>Take it‚Äôs use of the <a href="https://kotlinlang.org/docs/reference/opt-in-requirements.html"><code class="language-plaintext highlighter-rouge">RequiresOptIn</code></a> annotation (previously <code class="language-plaintext highlighter-rouge">Experimental</code> in Kotlin pre-1.3.70). There are some really nice ways this annotation is used, especially when introducing new library features like <code class="language-plaintext highlighter-rouge">Flow</code> and letting you know that parts of it are still experimental with the <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/1eeed509abbe8e542124841ce14884202463460b/kotlinx-coroutines-core/common/src/Annotations.kt#L40"><code class="language-plaintext highlighter-rouge">FlowPreview</code></a> annotation.</p> <p>However, the one that sticks out to me is the <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/1eeed509abbe8e542124841ce14884202463460b/kotlinx-coroutines-core/common/src/Annotations.kt#L66"><code class="language-plaintext highlighter-rouge">InternalCoroutinesApi</code></a> annotation. This annotation marks APIs that have to be public but should not be used outside the library and will result in a compiler error if the using code is not marked with <code class="language-plaintext highlighter-rouge">@OptIn(InternalCoroutinesApi::class)</code>. This is used to <strong>scope</strong> those APIs!</p> <p>How else can this be used to scope access? Let‚Äôs take inspiration from <a href="https://jakewharton.com/inline-classes-make-great-database-ids/">using inline classes for database IDs</a> and make an inline class to represent a password.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">inline</span> <span class="kd">class</span> <span class="nc">Password</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">value</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">toString</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"*****"</span>
<span class="p">}</span>
</code></pre></div></div> <p>This gives us some protection when dealing with passwords, making sure you don‚Äôt pass a password to a function not expecting one. But what about the function that needs to hash the password before persisting? Or the function that needs to compare that password against an existing password hash? Some things still need access to the raw password. Enter <code class="language-plaintext highlighter-rouge">RequiresOptIn</code>!</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiresOptIn</span><span class="p">(</span><span class="n">level</span> <span class="p">=</span> <span class="nc">RequiresOptIn</span><span class="p">.</span><span class="nc">Level</span><span class="p">.</span><span class="nc">ERROR</span><span class="p">)</span>
<span class="k">annotation</span> <span class="kd">class</span> <span class="nc">UnsafePassword</span>

<span class="k">inline</span> <span class="kd">class</span> <span class="nc">Password</span><span class="p">(</span>
  <span class="err">@</span><span class="n">property</span><span class="p">:</span><span class="nc">UnsafePassword</span>
  <span class="kd">val</span> <span class="py">value</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">toString</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"*****"</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now any code that tries to access value will get a compiler error unless it uses <code class="language-plaintext highlighter-rouge">@OptIn(UnsafePassword::class)</code>! The raw password has been scoped to only those functions that need it, and made that scope even more explicit!</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@OptIn</span><span class="p">(</span><span class="nc">UnsafePassword</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="k">fun</span> <span class="nf">hash</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nc">Password</span><span class="p">):</span> <span class="nc">String</span>
  <span class="p">=</span> <span class="c1">// password.value is no longer an error</span>
</code></pre></div></div> <p>Bonus, you can now search for usages of UnsafePassword to find everywhere that is dealing with a raw password.</p> <blockquote> <p>Disclaimer: I‚Äôm not a security expert. This password example is meant to be just that, an example. Make sure you are always following best practices when dealing with sensitive information.</p> </blockquote> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">I&#39;m probably taking Kotlin&#39;s OptIn annotation too far... But I found an interesting way to use it I thought I would share.üî¨<a href="https://t.co/O0RWugccbe">https://t.co/O0RWugccbe</a></p>&mdash; Brian Norman üê¢ (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1264305096546025473?ref_src=twsrc%5Etfw">May 23, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="next" href="https://blog.bnorm.dev/reac-functional-components-with-kotlinjs" title="NEXT: React Functional Components with Kotlin/JS">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/exploring-kotlin-ir" title="PREV: Exploring Kotlin IR">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2021 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
