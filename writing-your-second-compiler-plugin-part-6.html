<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Writing Your Second Kotlin Compiler Plugin, Part 6 — Support Libraries, Publishing, and Integration Testing · Dev Blog by Brian</title> <meta name="description" content=" At the time of writing this article, Kotlin compatibility for IR backend is in Alpha status andthe compiler plugin API is Experimental. As such, informatio..."> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6"> <link rel="alternate" type="application/atom+xml" title="Dev Blog by Brian" href="https://blog.bnorm.dev/feed.xml" /> <!-- OpenGraph metadatas --> <meta name="og:type" content="article"> <meta name="og:site_name" content="Dev Blog by Brian"> <meta name="og:title" content="Writing Your Second Kotlin Compiler Plugin, Part 6 — Support Libraries, Publishing, and Integration Testing"> <meta name="og:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6"> <meta name="og:description" content="Support Libraries, Publishing, and Integration Testing"> <!-- Twitter cards metadatas --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@bnormcodes"> <meta name="twitter:creator" content="@bnormcodes"> <meta name="twitter:title" content="Writing Your Second Kotlin Compiler Plugin, Part 6 — Support Libraries, Publishing, and Integration Testing"> <meta name="twitter:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6"> <meta name="twitter:description" content="Support Libraries, Publishing, and Integration Testing"> <!-- Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Writing Your Second Kotlin Compiler Plugin, Part 6 — Support Libraries, Publishing, and Integration Testing</h1> <time class="code">December 26, 2020</time> </div> <div class="divider"></div> <blockquote> <p>At the time of writing this article, <a href="https://kotlinlang.org/docs/reference/evolution/components-stability.html">Kotlin compatibility</a> for IR backend is in Alpha status and the compiler plugin API is Experimental. As such, information contained in this article about IR and compiler plugins could be out-of-date or incorrect. If official documentation exists, please refer to it first.</p> </blockquote> <p>As I wrap up this series of articles, there are a couple additional topics I wanted to cover in regards to Kotlin compiler plugins. None of these were worth a dedicated article, as they are each relatively small topics. Namely the ideas of support libraries, integration testing, and publishing a compiler plugin.</p> <ul> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1">Part 1 - Project Setup</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-2">Part 2 - Inspecting Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3">Part 3 - Navigating Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4">Part 4 - Building Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5">Part 5 - Transforming Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6">Part 6 - Support Libraries, Publishing, and Integration Testing</a></li> </ul> <h1 id="support-libraries">Support Libraries</h1> <p>A support library is required for a Kotlin compiler plugin if the plugin expects certain symbols to be present at compile time. In <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5#autobots-roll-out">Part 5</a>, the transformer created expected an annotation <code class="language-plaintext highlighter-rouge">DebugLog</code> to be present. In practice this annotation would be provided by a support library which the Gradle plugin can automatically add to the dependencies of the project.</p> <p>A support library is just another Kotlin project and is set up in the same way. The interesting part happens when you want to automatically include this project as a dependency when your compiler plugin is applied to a project. To do this, we’ll need to go all the way back to <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1#gradle-plugin">Part 1</a> when we configured the Gradle <code class="language-plaintext highlighter-rouge">KotlinCompilerPluginSupportPlugin</code> class. Using the <code class="language-plaintext highlighter-rouge">applyToCompilation</code> override function we can add a dependency to the project using the <code class="language-plaintext highlighter-rouge">kotlinCompilation</code> parameter.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">applyToCompilation</span><span class="p">(</span>
  <span class="n">kotlinCompilation</span><span class="p">:</span> <span class="nc">KotlinCompilation</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;</span>
<span class="p">):</span> <span class="nc">Provider</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">SubpluginOption</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
  <span class="n">kotlinCompilation</span><span class="p">.</span><span class="nf">dependencies</span> <span class="p">{</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"${BuildConfig.ANNOTATION_LIBRARY_GROUP}:${BuildConfig.ANNOTATION_LIBRARY_NAME}:${BuildConfig.ANNOTATION_LIBRARY_VERSION}"</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div></div> <p>Here we are adding the annotation library to the <code class="language-plaintext highlighter-rouge">implementation</code> dependency configuration. The coordinates of the annotation library are automatically generated with the [buildconfig] Gradle plugin.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">buildConfig</span> <span class="p">{</span>
  <span class="o">..</span><span class="p">.</span>
  
  <span class="kd">val</span> <span class="py">annotationProject</span> <span class="p">=</span> <span class="nf">project</span><span class="p">(</span><span class="s">":debuglog-annotation"</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"ANNOTATION_LIBRARY_GROUP"</span><span class="p">,</span> <span class="s">"\"${annotationProject.group}\""</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"ANNOTATION_LIBRARY_NAME"</span><span class="p">,</span> <span class="s">"\"${annotationProject.name}\""</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"ANNOTATION_LIBRARY_VERSION"</span><span class="p">,</span> <span class="s">"\"${annotationProject.version}\""</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>By adding this configuration to the Gradle plugin, the user of your compiler plugin does not need to worry about explicitly adding the support library to the list of dependencies.</p> <blockquote> <p>There is an open issue against Kotlin, <a href="https://youtrack.jetbrains.com/issue/KT-43385">KT-43385</a>, for an issue with IntelliJ and AndroidStudio not properly resolving dependencies added in this way. Gradle successfully builds the project, but the IDE will render the code with errors.</p> </blockquote> <h1 id="publishing">Publishing</h1> <p>I’ll keep this section short because I claim no expertise on this subject and there are many better guides available depending on what you are trying to achieve. However, I wanted to point out a couple things I have found helpful which will hopefully get you on the right path.</p> <p>To publish the Gradle plugin, you can use the officially supported <a href="https://plugins.gradle.org/docs/publish-plugin"><code class="language-plaintext highlighter-rouge">plugin-publish</code> Gradle plugin from the Gradle team</a>. This will require an account with Gradle and <a href="https://plugins.gradle.org/docs/submit">there is a list of steps to follow available</a>.</p> <p>To publish all the Kotlin projects (plugin, native plugin, and optional support library), you will need to use a Maven repository host. Two common options are <a href="https://bintray.com/">Bintray by JFrog</a> and <a href="https://oss.sonatype.org/">Nexus by Sonatype</a>. Nexus is what I use to sync with MavenCentral but <a href="https://central.sonatype.org/pages/ossrh-guide.html">there are many steps to complete</a> before you are allowed to publish. Bintray can be much easier to upload with the requirement of specifying additional Gradle repositories on the consumption side.</p> <p>Publishing is a tricky topic and there are a lot of different ways to get your plugin in other people’s hands. I find it easiest to explore publication Gradle code in other projects so I will link a few which I use as reference. Many take advantage of the <a href="https://github.com/vanniktech/gradle-maven-publish-plugin">gradle-maven-publish-plugin</a> plugin to perform publishing but I have no personal experience with it.</p> <ul> <li><a href="https://github.com/cashapp/exhaustive/blob/trunk/gradle/publish.gradle">exhaustive by Square</a></li> <li><a href="https://github.com/ZacSweers/redacted-compiler-plugin/blob/main/build.gradle">redacted-compiler-plugin by Zac Sweers</a></li> <li><a href="https://github.com/bnorm/kotlin-power-assert/blob/master/kotlin-power-assert-plugin/build.gradle.kts#L55">kotlin-power-assert by Brian Norman</a> (yes, I constantly reference my own)</li> </ul> <h1 id="integration-testing">Integration Testing</h1> <p>If you want to test local changes of your Kotlin compiler plugin, there is an extremely handy feature in Gradle called <a href="https://docs.gradle.org/current/userguide/composite_builds.html">composite builds</a>. This is very similar to multi-project builds, instead of doing it at the dependency level, you configure it at the root of the project. The documentation for this feature is excellent, and while the documentation makes it obvious what the benefits are for project level dependencies, it doesn’t mention that dependency substitution also works at the build dependency level (ie, Gradle plugins).</p> <p>Composite builds allow for testing your Kotlin compiler plugin against a local project without the need of publishing to a remote or local repository. If you include the build of your Kotlin compiler plugin project in another Gradle project, the Gradle plugin and all other dependencies will be substituted with the local compiler plugin project artifacts.</p> <p>To illustrate this, create a directory in you Kotlin compiler plugin project called <code class="language-plaintext highlighter-rouge">sample</code>. Fill this directory with a Gradle project, wrapper and all, that uses the Kotlin compiler plugin. In the <code class="language-plaintext highlighter-rouge">settings.gradle</code> or <code class="language-plaintext highlighter-rouge">settings.gradle.kts</code> files you can add <code class="language-plaintext highlighter-rouge">includeBuild("..")</code> and when you build the project in the <code class="language-plaintext highlighter-rouge">sample</code> directory, it will automatically build and use the Kotlin compiler plugin in the parent directory. You can see an example of this at work in the <a href="https://github.com/bnorm/debuglog/tree/main/debuglog-integration">debuglog</a> repository.</p> <p>This is extremely useful for all kinds of testing, especially when you want to perform integration testing against all of Kotlin’s platforms. While unit testing allows you to test Kotlin/JVM compilation, I have not found anything for unit testing Kotlin/Native compilation.</p> <hr /> <p>Thanks for reading my series of articles about Kotlin IR and writing a Kotlin compiler plugin! If you would like to explore a simple, working Kotlin compiler plugin created for this article series, you can check out the <a href="https://github.com/bnorm/debuglog">debuglog</a> repository.</p> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">Part 6! Wrapping up the series with some misfit and leftover topics. Short and sweet! 🍬 Thanks for reading! <a href="https://t.co/Zk4kyhy1wO">https://t.co/Zk4kyhy1wO</a></p>&mdash; Brian Norman 🐢 (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1342868320480088064?ref_src=twsrc%5Etfw">December 26, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5" title="PREV: Writing Your Second Kotlin Compiler Plugin, Part 5 — Transforming Kotlin IR">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2020 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
