<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Writing Your Second Kotlin Compiler Plugin, Part 5 — Transforming Kotlin IR · Dev Blog by Brian</title> <meta name="description" content=" At the time of writing this article, Kotlin compatibility for IR backend is in Alpha status andthe compiler plugin API is Experimental. As such, informatio..."> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5"> <link rel="alternate" type="application/atom+xml" title="Dev Blog by Brian" href="https://blog.bnorm.dev/feed.xml" /> <!-- OpenGraph metadatas --> <meta name="og:type" content="article"> <meta name="og:site_name" content="Dev Blog by Brian"> <meta name="og:title" content="Writing Your Second Kotlin Compiler Plugin, Part 5 — Transforming Kotlin IR"> <meta name="og:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5"> <meta name="og:description" content="Transforming Kotlin IR"> <!-- Twitter cards metadatas --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@bnormcodes"> <meta name="twitter:creator" content="@bnormcodes"> <meta name="twitter:title" content="Writing Your Second Kotlin Compiler Plugin, Part 5 — Transforming Kotlin IR"> <meta name="twitter:url" content="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5"> <meta name="twitter:description" content="Transforming Kotlin IR"> <!-- Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Writing Your Second Kotlin Compiler Plugin, Part 5 — Transforming Kotlin IR</h1> <time class="code">December 19, 2020</time> </div> <div class="divider"></div> <blockquote> <p>At the time of writing this article, <a href="https://kotlinlang.org/docs/reference/evolution/components-stability.html">Kotlin compatibility</a> for IR backend is in Alpha status and the compiler plugin API is Experimental. As such, information contained in this article about IR and compiler plugins could be out-of-date or incorrect. If official documentation exists, please refer to it first.</p> </blockquote> <p>And here we are, ready to transform Kotlin IR! After learning how to navigate and build Kotlin IR we now have the tools needed to transform Kotlin IR. This is a long one, so let’s get going!</p> <ul> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1">Part 1 - Project Setup</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-2">Part 2 - Inspecting Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3">Part 3 - Navigating Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4">Part 4 - Building Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-5">Part 5 - Transforming Kotlin IR</a></li> <li><a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6">Part 6 - Support Libraries, Publishing, and Integration Testing</a></li> </ul> <h1 id="déjà-vu">Déjà Vu</h1> <p>Just like in <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-3">Part 3</a> where we learned about the visitor pattern, transforming Kotlin IR is very similar but with a specific sub-class of <a href="https://github.com/JetBrains/kotlin/blob/1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/visitors/IrElementVisitor.kt#L23">IrElementVisitor</a> called <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/visitors/IrElementTransformer.kt#L24">IrElementTransformer</a>. This interface defines a return type of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L23">IrElement</a> at the class level but then overrides each visit function to be more specific types like <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L37">IrStatement</a> and <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrExpression.kt#L26">IrExpression</a>. And again, each <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/IrElement.kt#L23">IrElement</a> has 2 functions which take a transformer as the parameter.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">IrElementTransformer</span><span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">D</span><span class="p">):</span> <span class="nc">IrElement</span> <span class="p">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;</span> <span class="nf">transformChildren</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">IrElementTransformer</span><span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">D</span><span class="p">):</span> <span class="nc">Unit</span>
</code></pre></div></div> <p>The base <code class="language-plaintext highlighter-rouge">transform</code> function defaults to delegating the visitor function <code class="language-plaintext highlighter-rouge">accept</code> and overrides of the function in sub-classes usually are only needed to override the return type of the function to a more specific type. For example, the <code class="language-plaintext highlighter-rouge">transform</code> function in <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFile.kt#L42">IrFile</a> looks as follows.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;</span> <span class="nf">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">IrElementTransformer</span><span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">D</span><span class="p">):</span> <span class="nc">IrFile</span> <span class="p">=</span>
  <span class="nf">accept</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="nc">IrFile</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">transformChildren</code> function is - once again - much more interesting. Just like visiting all the children of each element, the transform function allows transforming each child element. For example let’s look at the implementation for <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrClass.kt#L31">IrClass</a>.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;</span> <span class="nf">transformChildren</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="nc">IrElementTransformer</span><span class="p">&lt;</span><span class="nc">D</span><span class="p">&gt;,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">D</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">thisReceiver</span> <span class="p">=</span> <span class="n">thisReceiver</span><span class="o">?.</span><span class="nf">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="n">typeParameters</span> <span class="p">=</span> <span class="n">typeParameters</span><span class="p">.</span><span class="nf">transformIfNeeded</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="n">declarations</span><span class="p">.</span><span class="nf">transformInPlace</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>Since each child property is defined as a <code class="language-plaintext highlighter-rouge">var</code> or a mutable collection, if the transform function returns a different instance, it can replace the previous instance. Also note that if a child element does not exist, it will not be transformed so it cannot be replaced. However when transforming an element, you can add child elements as needed which we will show later.</p> <h1 id="tracing-the-outline">Tracing The Outline</h1> <p>Inspired by <a href="https://www.youtube.com/watch?v=w-GMlaziIyo">Kevin Most’s 2018 KotlinConf talk</a>, which in turn was inspired by <a href="https://github.com/JakeWharton/hugo">Jake Wharton’s Hugo library</a>, let’s take the example of transforming functions to include debug print statements. We’ll just use <code class="language-plaintext highlighter-rouge">println</code> for logging but this could be expanded to make use of a proper logging framework.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DebugLog</span>
<span class="k">fun</span> <span class="nf">greet</span><span class="p">(</span><span class="n">greeting</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"Hello"</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"World"</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s">"${'$'}greeting, ${'$'}name!"</span>
<span class="p">}</span>
</code></pre></div></div> <p>In our example, given a function annotated with <code class="language-plaintext highlighter-rouge">@DebugLog</code>, println statements will be added at the entrance and all exits of the function. Here is what writing this by hand would look like.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DebugLog</span>
<span class="k">fun</span> <span class="nf">greet</span><span class="p">(</span><span class="n">greeting</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"Hello"</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"World"</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
  <span class="nf">println</span><span class="p">(</span><span class="s">"⇢ greet(greeting=$greeting, name=$name)"</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nc">TimeSource</span><span class="p">.</span><span class="nc">Monotonic</span><span class="p">.</span><span class="nf">markNow</span><span class="p">()</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="s">"${'$'}greeting, ${'$'}name!"</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}] = $result"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}] = $t"</span><span class="p">)</span>
    <span class="k">throw</span> <span class="n">t</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Yes, we are use</p> <h1 id="autobots-roll-out">Autobots, Roll Out!</h1> <p>To perform this debug log transformation, we’ll need a transformer implementation and ours will extend from <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/IrElementTransformerVoidWithContext.kt#L32">IrElementTransformerVoidWithContext</a>. This abstract transformer takes no input data (“Void”) and maintains an internal stack of various IR elements it has visited (“WithContext”).</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">DebugLogTransformer</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">pluginContext</span><span class="p">:</span> <span class="nc">IrPluginContext</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">annotationClass</span><span class="p">:</span> <span class="nc">IrClassSymbol</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">logFunction</span><span class="p">:</span> <span class="nc">IrSimpleFunctionSymbol</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">IrElementTransformerVoidWithContext</span><span class="p">()</span>
</code></pre></div></div> <p>Our transformer will require 3 parameters:</p> <ul> <li>The current <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrPluginContext.kt#L20">IrPluginContext</a> for building IR elements,</li> <li>An <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/symbols/IrSymbol.kt#L69">IrClassSymbol</a> for the annotation use to mark functions for debug logging,</li> <li>An <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/symbols/IrSymbol.kt#L99">IrSimpleFunctionSymbol</a> for the function used to log debug messages.</li> </ul> <p>We will also need a few local properties to reference known types, classes, and functions.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kd">val</span> <span class="py">typeUnit</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">unitType</span>
<span class="k">private</span> <span class="kd">val</span> <span class="py">typeThrowable</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">throwableType</span>

<span class="k">private</span> <span class="kd">val</span> <span class="py">classMonotonic</span> <span class="p">=</span>
  <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceClass</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.time.TimeSource.Monotonic"</span><span class="p">))</span><span class="o">!!</span>

<span class="k">private</span> <span class="kd">val</span> <span class="py">funMarkNow</span> <span class="p">=</span>
  <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceFunctions</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.time.TimeSource.markNow"</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">single</span><span class="p">()</span>

<span class="k">private</span> <span class="kd">val</span> <span class="py">funElapsedNow</span> <span class="p">=</span>
  <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceFunctions</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.time.TimeMark.elapsedNow"</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">single</span><span class="p">()</span>
</code></pre></div></div> <p>Next, we can override the <code class="language-plaintext highlighter-rouge">visitFunctionNew</code> function to intercept transformation of function statements. This visit function is specific to <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/IrElementTransformerVoidWithContext.kt#L32">IrElementTransformerVoidWithContext</a> as <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrFunction.kt#L31">IrFunction</a> is an element which is added to the context stack the abstract transformer maintains. As we know from <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4#hello-world-but-make-it-ir">Part 4</a>, a function body can be null. So to see if we should transform an intercepted function we need to check if it has a body and has the correct annotation applied. For the annotation check, we can use the extension function <code class="language-plaintext highlighter-rouge">hasAnnotation</code>.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">visitFunctionNew</span><span class="p">(</span><span class="n">declaration</span><span class="p">:</span> <span class="nc">IrFunction</span><span class="p">):</span> <span class="nc">IrStatement</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">declaration</span><span class="p">.</span><span class="n">body</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">declaration</span><span class="p">.</span><span class="nf">hasAnnotation</span><span class="p">(</span><span class="n">annotationClass</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">declaration</span><span class="p">.</span><span class="n">body</span> <span class="p">=</span> <span class="nf">irDebug</span><span class="p">(</span><span class="n">declaration</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">visitFunctionNew</span><span class="p">(</span><span class="n">declaration</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>Before tackling the <code class="language-plaintext highlighter-rouge">irDebug</code> function we need to create, let’s first take a look at the IR helpers for the entrance and exit log statements.</p> <h1 id="making-an-entrance">Making An Entrance</h1> <p>When the function is first entered, we need to make a call to <code class="language-plaintext highlighter-rouge">println</code> to display the function name and supplied parameter values.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">println</span><span class="p">(</span><span class="s">"⇢ greet(greeting=$greeting, name=$name)"</span><span class="p">)</span>
</code></pre></div></div> <p>We created something similar to this in <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4#hello-world-but-make-it-ir">Part 4</a> so the following should look relatively familiar.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nc">IrBuilderWithScope</span><span class="p">.</span><span class="nf">irDebugEnter</span><span class="p">(</span>
  <span class="n">function</span><span class="p">:</span> <span class="nc">IrFunction</span>
<span class="p">):</span> <span class="nc">IrCall</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">concat</span> <span class="p">=</span> <span class="nf">irConcat</span><span class="p">()</span>
  <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">"⇢ ${function.name}("</span><span class="p">))</span>
  <span class="k">for</span> <span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">valueParameter</span><span class="p">)</span> <span class="k">in</span> <span class="n">function</span><span class="p">.</span><span class="n">valueParameters</span><span class="p">.</span><span class="nf">withIndex</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">", "</span><span class="p">))</span>
    <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">"${valueParameter.name}="</span><span class="p">))</span>
    <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irGet</span><span class="p">(</span><span class="n">valueParameter</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">")"</span><span class="p">))</span>

  <span class="k">return</span> <span class="nf">irCall</span><span class="p">(</span><span class="n">logFunction</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
    <span class="n">call</span><span class="p">.</span><span class="nf">putValueArgument</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">concat</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>This does introduce a new builder function <code class="language-plaintext highlighter-rouge">irConcat</code>. <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrStringConcatenation.kt#L19">IrStringConcatenation</a> is a helpful IR element for building interpolated strings and is used here to replicate Kotlin string templates but at the IR level. Also notice the <code class="language-plaintext highlighter-rouge">irGet</code> builder which is able to access the value of the function parameter.</p> <h1 id="making-an-exit-thrice">Making An Exit, Thrice!</h1> <p>On exit, we want to log the result or the exception thrown. If the function returns Unit we can skip displaying the result as it is known to be nothing. This results in needing to replicate the following 3 <code class="language-plaintext highlighter-rouge">println</code> statements.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}] = $result"</span><span class="p">)</span>
<span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}] = $t"</span><span class="p">)</span>
<span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}]"</span><span class="p">)</span>
</code></pre></div></div> <p>Similar to entrance logging, we can use an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrStringConcatenation.kt#L19">IrStringConcatenation</a> again to build the message string. However we need 2 additional pieces of information, the <code class="language-plaintext highlighter-rouge">startTime</code> and the <code class="language-plaintext highlighter-rouge">result</code> or exception.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nc">IrBuilderWithScope</span><span class="p">.</span><span class="nf">irDebugExit</span><span class="p">(</span>
  <span class="n">function</span><span class="p">:</span> <span class="nc">IrFunction</span><span class="p">,</span>
  <span class="n">startTime</span><span class="p">:</span> <span class="nc">IrValueDeclaration</span><span class="p">,</span>
  <span class="n">result</span><span class="p">:</span> <span class="nc">IrExpression</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">):</span> <span class="nc">IrCall</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">concat</span> <span class="p">=</span> <span class="nf">irConcat</span><span class="p">()</span>
  <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">"⇠ ${function.name} ["</span><span class="p">))</span>
  <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irCall</span><span class="p">(</span><span class="n">funElapsedNow</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
    <span class="n">call</span><span class="p">.</span><span class="n">dispatchReceiver</span> <span class="p">=</span> <span class="nf">irGet</span><span class="p">(</span><span class="n">startTime</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">"] = "</span><span class="p">))</span>
    <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">concat</span><span class="p">.</span><span class="nf">addArgument</span><span class="p">(</span><span class="nf">irString</span><span class="p">(</span><span class="s">"]"</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nf">irCall</span><span class="p">(</span><span class="n">logFunction</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
    <span class="n">call</span><span class="p">.</span><span class="nf">putValueArgument</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">concat</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">startTime</code> is provided as an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrValueDeclaration.kt#L13">IrValueDeclaration</a>. This is a reference to a local variable which can be accessed using <code class="language-plaintext highlighter-rouge">irGet</code>. To use the <code class="language-plaintext highlighter-rouge">elapsedNow</code> function on the start time <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.time/-time-mark/">TimeMark</a>, we can use the <code class="language-plaintext highlighter-rouge">funElapsedNow</code> symbol and provide the <code class="language-plaintext highlighter-rouge">startTime</code> variable as the <code class="language-plaintext highlighter-rouge">dispatchReceiver</code> for the <code class="language-plaintext highlighter-rouge">irCall</code>. Note that the other receiver type of <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrCall.kt#L22">IrCall</a>, <code class="language-plaintext highlighter-rouge">extensionReceiver</code>, is used for specifying the receiver for extension functions.</p> <p>The <code class="language-plaintext highlighter-rouge">result</code> parameter is an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrExpression.kt#L26">IrExpression</a> which will provide the result of the annotated function or the exception thrown. This is optional for the case when the annotated function returns Unit. An <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrExpression.kt#L26">IrExpression</a> can be added directly to an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrStringConcatenation.kt#L19">IrStringConcatenation</a> as it can handle concatenating arbitrary IR expressions.</p> <h1 id="on-your-mark">On Your Mark…</h1> <p>There are a couple other small section I want to go over before showing the full <code class="language-plaintext highlighter-rouge">irDebug</code> function implementation.</p> <p>To create a temporary local variable you can use the <code class="language-plaintext highlighter-rouge">irTemporary</code> builder. This in combination with <code class="language-plaintext highlighter-rouge">irCall</code> and <code class="language-plaintext highlighter-rouge">irGetObject</code> we can save the start time for the annotated function. This is the same as calling <code class="language-plaintext highlighter-rouge">TimeSource.Monotonic.markNow()</code> and saving to a local variable. Note that <code class="language-plaintext highlighter-rouge">irTemporary</code> automatically adds the returned <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/declarations/IrVariable.kt#L24">IrVariable</a> to the surrounding <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L44">IrStatementsBuilder</a> so be careful where you invoke this builder.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nf">irTemporary</span><span class="p">(</span><span class="nf">irCall</span><span class="p">(</span><span class="n">funMarkNow</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
  <span class="n">call</span><span class="p">.</span><span class="n">dispatchReceiver</span> <span class="p">=</span> <span class="nf">irGetObject</span><span class="p">(</span><span class="n">classMonotonic</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div> <p>To build a try-catch statement, there unfortunately is no builder function so we need to construct the implementation class directly. Since a <code class="language-plaintext highlighter-rouge">try</code> block is an expression in Kotlin, we need to provide a result type for the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrTry.kt#L23">IrTry</a>. We also need to build a variable for each <code class="language-plaintext highlighter-rouge">catch</code> expression to reference the caught throwable inside a <code class="language-plaintext highlighter-rouge">irCatch</code> builder. All of this will be built within a <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/builders/IrBuilder.kt#L37">IrBuilderWithScope</a> which provides <code class="language-plaintext highlighter-rouge">scope</code>, <code class="language-plaintext highlighter-rouge">startOffset</code>, and <code class="language-plaintext highlighter-rouge">endOffset</code> as class properties.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">tryBlock</span><span class="p">:</span> <span class="nc">IrExpression</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>

<span class="kd">val</span> <span class="py">throwable</span> <span class="p">=</span> <span class="nf">buildVariable</span><span class="p">(</span>
  <span class="n">scope</span><span class="p">.</span><span class="nf">getLocalDeclarationParent</span><span class="p">(),</span> <span class="n">startOffset</span><span class="p">,</span> <span class="n">endOffset</span><span class="p">,</span> <span class="nc">IrDeclarationOrigin</span><span class="p">.</span><span class="nc">CATCH_PARAMETER</span><span class="p">,</span>
  <span class="nc">Name</span><span class="p">.</span><span class="nf">identifier</span><span class="p">(</span><span class="s">"t"</span><span class="p">),</span> <span class="n">typeThrowable</span>
<span class="p">)</span>

<span class="nc">IrTryImpl</span><span class="p">(</span><span class="n">startOffset</span><span class="p">,</span> <span class="n">endOffset</span><span class="p">,</span> <span class="n">tryBlock</span><span class="p">.</span><span class="n">type</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">irTry</span> <span class="p">-&gt;</span>
  <span class="n">irTry</span><span class="p">.</span><span class="n">tryResult</span> <span class="p">=</span> <span class="n">tryResult</span>
  <span class="n">irTry</span><span class="p">.</span><span class="n">catches</span> <span class="p">+=</span> <span class="nf">irCatch</span><span class="p">(</span><span class="n">throwable</span><span class="p">,</span> <span class="o">..</span><span class="p">.</span> <span class="k">as</span> <span class="nc">IrExpression</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>The expression block of the <code class="language-plaintext highlighter-rouge">try</code> expression is built using <code class="language-plaintext highlighter-rouge">irBlock</code>. The original statements of the annotated function body are added as statements to the <code class="language-plaintext highlighter-rouge">try</code> expression as well as a final call to <code class="language-plaintext highlighter-rouge">irDebugExit</code> if the function returns Unit.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">tryBlock</span> <span class="p">=</span> <span class="nf">irBlock</span><span class="p">(</span><span class="n">resultType</span> <span class="p">=</span> <span class="n">function</span><span class="p">.</span><span class="n">returnType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">statement</span> <span class="k">in</span> <span class="n">body</span><span class="p">.</span><span class="n">statements</span><span class="p">)</span> <span class="p">+</span><span class="n">statement</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">function</span><span class="p">.</span><span class="n">returnType</span> <span class="p">==</span> <span class="n">typeUnit</span><span class="p">)</span> <span class="p">+</span><span class="nf">irDebugExit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>The expression block of the <code class="language-plaintext highlighter-rouge">catch</code> expression is also built using <code class="language-plaintext highlighter-rouge">irBlock</code>. This block will use <code class="language-plaintext highlighter-rouge">irDebugExit</code> to log the exception and then preserve the exception by rethrowing it.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">irTry</span><span class="p">.</span><span class="n">catches</span> <span class="p">+=</span> <span class="nf">irCatch</span><span class="p">(</span><span class="n">throwable</span><span class="p">,</span> <span class="nf">irBlock</span> <span class="p">{</span>
  <span class="p">+</span><span class="nf">irDebugExit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="nf">irGet</span><span class="p">(</span><span class="n">throwable</span><span class="p">))</span>
  <span class="p">+</span><span class="nf">irThrow</span><span class="p">(</span><span class="nf">irGet</span><span class="p">(</span><span class="n">throwable</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div> <h1 id="get-set">Get Set…</h1> <p>And here is the <code class="language-plaintext highlighter-rouge">irDebug</code> function, taking the annotated function and the original body as parameters.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">irDebug</span><span class="p">(</span>
  <span class="n">function</span><span class="p">:</span> <span class="nc">IrFunction</span><span class="p">,</span>
  <span class="n">body</span><span class="p">:</span> <span class="nc">IrBody</span>
<span class="p">):</span> <span class="nc">IrBlockBody</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">DeclarationIrBuilder</span><span class="p">(</span><span class="n">pluginContext</span><span class="p">,</span> <span class="n">function</span><span class="p">.</span><span class="n">symbol</span><span class="p">).</span><span class="nf">irBlockBody</span> <span class="p">{</span>
    <span class="p">+</span><span class="nf">irDebugEnter</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="nf">irTemporary</span><span class="p">(</span><span class="nf">irCall</span><span class="p">(</span><span class="n">funMarkNow</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">call</span> <span class="p">-&gt;</span>
      <span class="n">call</span><span class="p">.</span><span class="n">dispatchReceiver</span> <span class="p">=</span> <span class="nf">irGetObject</span><span class="p">(</span><span class="n">classMonotonic</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="kd">val</span> <span class="py">tryBlock</span> <span class="p">=</span> <span class="nf">irBlock</span><span class="p">(</span><span class="n">resultType</span> <span class="p">=</span> <span class="n">function</span><span class="p">.</span><span class="n">returnType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">statement</span> <span class="k">in</span> <span class="n">body</span><span class="p">.</span><span class="n">statements</span><span class="p">)</span> <span class="p">+</span><span class="n">statement</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">function</span><span class="p">.</span><span class="n">returnType</span> <span class="p">==</span> <span class="n">typeUnit</span><span class="p">)</span> <span class="p">+</span><span class="nf">irDebugExit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">)</span>
    <span class="p">}.</span><span class="nf">transform</span><span class="p">(</span><span class="nc">DebugLogReturnTransformer</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">),</span> <span class="k">null</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">throwable</span> <span class="p">=</span> <span class="nf">buildVariable</span><span class="p">(</span>
      <span class="n">scope</span><span class="p">.</span><span class="nf">getLocalDeclarationParent</span><span class="p">(),</span> <span class="n">startOffset</span><span class="p">,</span> <span class="n">endOffset</span><span class="p">,</span> <span class="nc">IrDeclarationOrigin</span><span class="p">.</span><span class="nc">CATCH_PARAMETER</span><span class="p">,</span>
      <span class="nc">Name</span><span class="p">.</span><span class="nf">identifier</span><span class="p">(</span><span class="s">"t"</span><span class="p">),</span> <span class="n">typeThrowable</span>
    <span class="p">)</span>

    <span class="p">+</span><span class="nc">IrTryImpl</span><span class="p">(</span><span class="n">startOffset</span><span class="p">,</span> <span class="n">endOffset</span><span class="p">,</span> <span class="n">tryBlock</span><span class="p">.</span><span class="n">type</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">irTry</span> <span class="p">-&gt;</span>
      <span class="n">irTry</span><span class="p">.</span><span class="n">tryResult</span> <span class="p">=</span> <span class="n">tryBlock</span>
      <span class="n">irTry</span><span class="p">.</span><span class="n">catches</span> <span class="p">+=</span> <span class="nf">irCatch</span><span class="p">(</span><span class="n">throwable</span><span class="p">,</span> <span class="nf">irBlock</span> <span class="p">{</span>
        <span class="p">+</span><span class="nf">irDebugExit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="nf">irGet</span><span class="p">(</span><span class="n">throwable</span><span class="p">))</span>
        <span class="p">+</span><span class="nf">irThrow</span><span class="p">(</span><span class="nf">irGet</span><span class="p">(</span><span class="n">throwable</span><span class="p">))</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>But, wait! What is this <code class="language-plaintext highlighter-rouge">DebugLogReturnTransformer</code> transformer on the <code class="language-plaintext highlighter-rouge">tryBlock</code>? This secondary transformer is used to convert <code class="language-plaintext highlighter-rouge">return</code> statements so the result can be logged before exiting the function.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="s">"${'$'}greeting, ${'$'}name!"</span>
<span class="nf">println</span><span class="p">(</span><span class="s">"⇠ greet [${startTime.elapsedNow()}] = $result"</span><span class="p">)</span>
<span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <p>To replicate the above transformation, we can intercept <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrReturn.kt#L21">IrReturn</a> elements with a secondary transformer.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">inner</span> <span class="kd">class</span> <span class="nc">DebugLogReturnTransformer</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">function</span><span class="p">:</span> <span class="nc">IrFunction</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">startTime</span><span class="p">:</span> <span class="nc">IrVariable</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">IrElementTransformerVoidWithContext</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">visitReturn</span><span class="p">(</span><span class="n">expression</span><span class="p">:</span> <span class="nc">IrReturn</span><span class="p">):</span> <span class="nc">IrExpression</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">returnTargetSymbol</span> <span class="p">!=</span> <span class="n">function</span><span class="p">.</span><span class="n">symbol</span><span class="p">)</span> <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">visitReturn</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">DeclarationIrBuilder</span><span class="p">(</span><span class="n">pluginContext</span><span class="p">,</span> <span class="n">function</span><span class="p">.</span><span class="n">symbol</span><span class="p">).</span><span class="nf">irBlock</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">irTemporary</span><span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
      <span class="p">+</span><span class="nf">irDebugExit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="nf">irGet</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
      <span class="p">+</span><span class="n">expression</span><span class="p">.</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="n">value</span> <span class="p">=</span> <span class="nf">irGet</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>We should only transform <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrReturn.kt#L21">IrReturn</a> expressions that return from the annotated function. This can be checked by looking at the <code class="language-plaintext highlighter-rouge">returnTargetSymbol</code> property of the <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/ir.tree/src/org/jetbrains/kotlin/ir/expressions/IrReturn.kt#L21">IrReturn</a> element. To perform the actual transformation we need to do 4 things:</p> <ol> <li>Create a surrounding <code class="language-plaintext highlighter-rouge">irBlock</code> to hold multiple statements in a single expression,</li> <li>Create a temporary variable using <code class="language-plaintext highlighter-rouge">irTemporary</code> to save the value returned,</li> <li>Add our <code class="language-plaintext highlighter-rouge">irDebugExit</code> expression builder to log the result,</li> <li>Add the original return to the block but instead return the value of the temporary variable.</li> </ol> <h1 id="go">Go!</h1> <p>Now let’s apply this debug log transformer against the provided <code class="language-plaintext highlighter-rouge">moduleFragment</code> of an <a href="https://github.com/JetBrains/kotlin/blob/v1.4.20/compiler/ir/backend.common/src/org/jetbrains/kotlin/backend/common/extensions/IrGenerationExtension.kt#L12">IrGenerationExtension</a>. Grab a reference to the <code class="language-plaintext highlighter-rouge">DebugLog</code> annotation and <code class="language-plaintext highlighter-rouge">println</code> function from the <code class="language-plaintext highlighter-rouge">pluginContext</code> and then call <code class="language-plaintext highlighter-rouge">transform</code> with an instance of <code class="language-plaintext highlighter-rouge">DebugLogTransformer</code> on <code class="language-plaintext highlighter-rouge">moduleFragment</code>.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">generate</span><span class="p">(</span><span class="n">moduleFragment</span><span class="p">:</span> <span class="nc">IrModuleFragment</span><span class="p">,</span> <span class="n">pluginContext</span><span class="p">:</span> <span class="nc">IrPluginContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">typeAnyNullable</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="n">irBuiltIns</span><span class="p">.</span><span class="n">anyNType</span>

  <span class="kd">val</span> <span class="py">debugLogAnnotation</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceClass</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"DebugLog"</span><span class="p">))</span><span class="o">!!</span>
  <span class="kd">val</span> <span class="py">funPrintln</span> <span class="p">=</span> <span class="n">pluginContext</span><span class="p">.</span><span class="nf">referenceFunctions</span><span class="p">(</span><span class="nc">FqName</span><span class="p">(</span><span class="s">"kotlin.io.println"</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">single</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">parameters</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">valueParameters</span>
      <span class="n">parameters</span><span class="p">.</span><span class="n">size</span> <span class="p">==</span> <span class="mi">1</span> <span class="p">&amp;&amp;</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="p">==</span> <span class="n">typeAnyNullable</span>
    <span class="p">}</span>

  <span class="n">moduleFragment</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="nc">DebugLogTransformer</span><span class="p">(</span><span class="n">pluginContext</span><span class="p">,</span> <span class="n">debugLogAnnotation</span><span class="p">,</span> <span class="n">funPrintln</span><span class="p">),</span> <span class="k">null</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>To see this in action, we can use the <code class="language-plaintext highlighter-rouge">kotlin-compile-testing</code> library as shown in <a href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1#kotlin-plugin---testing">Part 1</a>. With the compilation result object, we can get a <a href="https://docs.oracle.com/en/java/javase/15/docs/api/java.base/java/lang/ClassLoader.html">ClassLoader</a> of the compiled classes. From this we can get the <code class="language-plaintext highlighter-rouge">main</code> function and run it.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">compile</span><span class="p">(</span>
  <span class="n">sourceFile</span> <span class="p">=</span> <span class="nc">SourceFile</span><span class="p">.</span><span class="nf">kotlin</span><span class="p">(</span>
    <span class="s">"main.kt"</span><span class="p">,</span>
    <span class="s">"""
      annotation class DebugLog
      
      fun main() {
        println(greet())
        println(greet(name = "Kotlin IR"))
      }
      
      @DebugLog
      fun greet(greeting: String = "Hello", name: String = "World"): String { 
        Thread.sleep(15) // simulate work
        return "${'$'}greeting, ${'$'}name!"
      }
    """</span><span class="p">.</span><span class="nf">trimIndent</span><span class="p">()</span>
  <span class="p">)</span>
<span class="p">)</span>
<span class="nf">assertEquals</span><span class="p">(</span><span class="nc">KotlinCompilation</span><span class="p">.</span><span class="nc">ExitCode</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">exitCode</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">kClazz</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">classLoader</span><span class="p">.</span><span class="nf">loadClass</span><span class="p">(</span><span class="s">"MainKt"</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">main</span> <span class="p">=</span> <span class="n">kClazz</span><span class="p">.</span><span class="n">declaredMethods</span><span class="p">.</span><span class="nf">single</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="s">"main"</span> <span class="p">&amp;&amp;</span> <span class="n">it</span><span class="p">.</span><span class="n">parameterCount</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">}</span>
<span class="n">main</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
</code></pre></div></div> <p>After running this test, we should see the following output.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>⇢ greet(greeting=Hello, name=World)
⇠ greet [20.1ms] = Hello, World!
Hello, World!
⇢ greet(greeting=Hello, name=Kotlin IR)
⇠ greet [15.6ms] = Hello, Kotlin IR!
</code></pre></div></div> <hr /> <p>I know this article was longer than usual and full of a lot of new things, but see if you can put the pieces together and get something working! Can you make it so <em>all</em> functions in a <em>class</em> or even <em>file</em> annotated with <code class="language-plaintext highlighter-rouge">@DebugLog</code> are transformed? (Hint: <code class="language-plaintext highlighter-rouge">IrElementTransformerVoidWithContext.currentClass</code>) Can you make the <code class="language-plaintext highlighter-rouge">irDebugEnter</code> and <code class="language-plaintext highlighter-rouge">irDebugExit</code> functions abstract so different logging frameworks and message formats could be used by different implementations of <code class="language-plaintext highlighter-rouge">DebugLogTransformer</code>?</p> <p>If you want to check out a working Kotlin compiler plugin created from all the code snippets above, you can check out the <a href="https://github.com/bnorm/debuglog">debuglog</a> repository. And if you want to try creating your own Kotlin compiler plugin, take a look at the <a href="https://github.com/bnorm/kotlin-ir-plugin-template">GitHub template</a> repository I created.</p> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">Part 5 is done! Enter the third act of this series and exit with hopefully a deeper understanding of how to transform Kotlin IR! 🚪 <a href="https://t.co/VHooKWQyS0">https://t.co/VHooKWQyS0</a></p>&mdash; Brian Norman 🐢 (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1340337338879229952?ref_src=twsrc%5Etfw">December 19, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="next" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-6" title="NEXT: Writing Your Second Kotlin Compiler Plugin, Part 6 — Support Libraries, Publishing, and Integration Testing">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-4" title="PREV: Writing Your Second Kotlin Compiler Plugin, Part 4 — Building Kotlin IR">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2022 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
