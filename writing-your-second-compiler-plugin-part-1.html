<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Writing Your Second Kotlin Compiler Plugin, Part 1 ‚Äî Project Setup ¬∑ Dev Blog for Brian</title> <meta name="description" content=" At the time of writing this article, Kotlin compatibility for IR backend is in Alpha status andthe compiler plugin API is Experimental. As such, informatio..."> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1"> <link rel="alternate" type="application/atom+xml" title="Dev Blog for Brian" href="https://blog.bnorm.dev/feed.xml" /> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Writing Your Second Kotlin Compiler Plugin, Part 1 ‚Äî Project Setup</h1> <time class="code">November 21, 2020</time> </div> <div class="divider"></div> <blockquote> <p>At the time of writing this article, <a href="https://kotlinlang.org/docs/reference/evolution/components-stability.html">Kotlin compatibility</a> for IR backend is in Alpha status and the compiler plugin API is Experimental. As such, information contained in this article about IR and compiler plugins could be out-of-date or incorrect. If official documentation exists, please refer to it first.</p> </blockquote> <p>I‚Äôve been wanting to write this series of blog posts for a while. Inspired By Kevin Most‚Äôs 2018 KotlinConf talk - <a href="https://www.youtube.com/watch?v=w-GMlaziIyo">Writing Your First Kotlin Compiler Plugin</a> - I wanted to show how we could write our second compiler plugin, something IR based that works on all Kotlin targets.</p> <p>In this first part we will go over the project setup required to build a compiler plugin. In later parts we will explore navigating and transforming Kotlin IR.</p> <ul> <li>Part 2 - Navigating Kotlin IR</li> <li>Part 3 - Transforming Kotlin IR</li> <li>Part 4 - ?</li> <li>Part ? - Publishing a Kotlin Compiler Plugin</li> </ul> <h1 id="setup">Setup</h1> <p>There are a number pieces to a Kotlin compiler plugin. At least 3 modules are required if you want to support all Kotlin targets:</p> <ul> <li>Gradle plugin which adds your plugin to Kotlin compiler classpath,</li> <li>Kotlin compiler plugin for non-native Kotlin platforms,</li> <li>Kotlin compiler plugin for Kotlin/Native platform.</li> </ul> <p>Kotlin/Native requires a separate compiler plugin because certain classes used by the Kotlin compiler have a different package on Kotlin/Native. We‚Äôll explore this oddity more in-depth later.</p> <h1 id="gradle-plugin">Gradle Plugin</h1> <p>The <a href="https://github.com/bnorm/kotlin-ir-plugin-template/tree/medium-part1/kotlin-ir-plugin-gradle">Gradle plugin</a> part of a Kotlin compiler plugin project is responsible for defining a few things:</p> <ul> <li>Artifact coordinates of the Kotlin compiler plugin,</li> <li>ID string of the Kotlin compiler plugin,</li> <li>Translation of Gradle configuration to command line options.</li> </ul> <p>The artifact coordinates are used to download the correct compiler plugin artifact from MavenCentral (or other location) to include on the compiler plugin classpath. The compiler plugin ID string is used to separate command line options by plugin to avoid conflicting options between multiple plugins.</p> <p>The artifact coordinates and ID we‚Äôll <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin-gradle/build.gradle.kts">define with Gradle</a> using the <a href="https://github.com/gmazzo/gradle-buildconfig-plugin">buildconfig</a> plugin. Since the artifact coordinates - group, name, and version - are already defined by Gradle and the Kotlin compiler plugin ID will be the Gradle plugin ID, this will make things consistent when everything is published.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">buildConfig</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">project</span> <span class="p">=</span> <span class="nf">project</span><span class="p">(</span><span class="s">":kotlin-ir-plugin"</span><span class="p">)</span>
  <span class="nf">packageName</span><span class="p">(</span><span class="n">project</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"KOTLIN_PLUGIN_ID"</span><span class="p">,</span> <span class="s">"\"${rootProject.extra["</span><span class="n">kotlin_plugin_id</span><span class="s">"]}\""</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"KOTLIN_PLUGIN_GROUP"</span><span class="p">,</span> <span class="s">"\"${project.group}\""</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"KOTLIN_PLUGIN_NAME"</span><span class="p">,</span> <span class="s">"\"${project.name}\""</span><span class="p">)</span>
  <span class="nf">buildConfigField</span><span class="p">(</span><span class="s">"String"</span><span class="p">,</span> <span class="s">"KOTLIN_PLUGIN_VERSION"</span><span class="p">,</span> <span class="s">"\"${project.version}\""</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>These buildconfig values are used by a <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin-gradle/src/main/kotlin/com/bnorm/template/TemplateGradlePlugin.kt"><code class="language-plaintext highlighter-rouge">KotlinCompilerPluginSupportPlugin</code></a> implementation which is responsible for bridging between Gradle and the Kotlin compiler.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TemplateGradlePlugin</span> <span class="p">:</span> <span class="nc">KotlinCompilerPluginSupportPlugin</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">apply</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Project</span><span class="p">):</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="nf">with</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">extensions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="s">"template"</span><span class="p">,</span> <span class="nc">TemplateGradleExtension</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">isApplicable</span><span class="p">(</span><span class="n">kotlinCompilation</span><span class="p">:</span> <span class="nc">KotlinCompilation</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">true</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getCompilerPluginId</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_ID</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getPluginArtifact</span><span class="p">():</span> <span class="nc">SubpluginArtifact</span> <span class="p">=</span> <span class="nc">SubpluginArtifact</span><span class="p">(</span>
    <span class="n">groupId</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_GROUP</span><span class="p">,</span>
    <span class="n">artifactId</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_NAME</span><span class="p">,</span>
    <span class="n">version</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_VERSION</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getPluginArtifactForNative</span><span class="p">():</span> <span class="nc">SubpluginArtifact</span> <span class="p">=</span> <span class="nc">SubpluginArtifact</span><span class="p">(</span>
    <span class="n">groupId</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_GROUP</span><span class="p">,</span>
    <span class="n">artifactId</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_NAME</span> <span class="p">+</span> <span class="s">"-native"</span><span class="p">,</span>
    <span class="n">version</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_VERSION</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">applyToCompilation</span><span class="p">(</span>
    <span class="n">kotlinCompilation</span><span class="p">:</span> <span class="nc">KotlinCompilation</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;</span>
  <span class="p">):</span> <span class="nc">Provider</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">SubpluginOption</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">project</span> <span class="p">=</span> <span class="n">kotlinCompilation</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">project</span>
    <span class="kd">val</span> <span class="py">extension</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="n">extensions</span><span class="p">.</span><span class="nf">getByType</span><span class="p">(</span><span class="nc">TemplateGradleExtension</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">project</span><span class="p">.</span><span class="nf">provider</span> <span class="p">{</span>
      <span class="nf">listOf</span><span class="p">(</span>
        <span class="nc">SubpluginOption</span><span class="p">(</span><span class="n">key</span> <span class="p">=</span> <span class="s">"string"</span><span class="p">,</span> <span class="n">value</span> <span class="p">=</span> <span class="n">extension</span><span class="p">.</span><span class="n">stringProperty</span><span class="p">.</span><span class="k">get</span><span class="p">()),</span>
        <span class="nc">SubpluginOption</span><span class="p">(</span><span class="n">key</span> <span class="p">=</span> <span class="s">"file"</span><span class="p">,</span> <span class="n">value</span> <span class="p">=</span> <span class="n">extension</span><span class="p">.</span><span class="n">fileProperty</span><span class="p">.</span><span class="k">get</span><span class="p">().</span><span class="n">asFile</span><span class="p">.</span><span class="n">path</span><span class="p">),</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Any <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin-gradle/src/main/kotlin/com/bnorm/template/TemplateGradleExtension.kt">custom Gradle properties</a> defined in a <a href="https://docs.gradle.org/current/userguide/custom_plugins.html">Gradle extension</a> are translated to Kotlin compiler arguments using the <code class="language-plaintext highlighter-rouge">applyToCompilation</code> function. These will be read by our Kotlin compiler plugin which is next!</p> <h1 id="kotlin-plugin">Kotlin Plugin</h1> <p>A Kotlin compiler plugin starts with a <code class="language-plaintext highlighter-rouge">ComponentRegistrar</code> and <code class="language-plaintext highlighter-rouge">CommandLineProcessor</code> implementation. Both of these classes are loaded by the Kotlin compiler using a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html">ServiceLoader</a> so we will use the <a href="https://github.com/google/auto/tree/master/service"><code class="language-plaintext highlighter-rouge">auto-service</code></a> annotation processer to automatically generate the required files.</p> <p>The <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin/src/main/kotlin/com/bnorm/template/TemplateCommandLineProcessor.kt"><code class="language-plaintext highlighter-rouge">CommandLineProcessor</code></a> is pretty easy to understand: It defines the Kotlin compiler plugin ID string (same as in Gradle plugin) and expected command line options. The processor is also responsible for parsing the command line options of the plugin and placing them in a <code class="language-plaintext highlighter-rouge">CompilerConfiguration</code>. It should read and process the same values defined by the Gradle plugin.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoService</span><span class="p">(</span><span class="nc">CommandLineProcessor</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">TemplateCommandLineProcessor</span> <span class="p">:</span> <span class="nc">CommandLineProcessor</span> <span class="p">{</span>
  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">OPTION_STRING</span> <span class="p">=</span> <span class="s">"string"</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">OPTION_FILE</span> <span class="p">=</span> <span class="s">"file"</span>

    <span class="kd">val</span> <span class="py">ARG_STRING</span> <span class="p">=</span> <span class="nc">CompilerConfigurationKey</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;(</span><span class="nc">OPTION_STRING</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">ARG_FILE</span> <span class="p">=</span> <span class="nc">CompilerConfigurationKey</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;(</span><span class="nc">OPTION_FILE</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="py">pluginId</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">KOTLIN_PLUGIN_ID</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="py">pluginOptions</span><span class="p">:</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="nc">CliOption</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
    <span class="nc">CliOption</span><span class="p">(</span>
      <span class="n">optionName</span> <span class="p">=</span> <span class="nc">OPTION_STRING</span><span class="p">,</span>
      <span class="n">valueDescription</span> <span class="p">=</span> <span class="s">"string"</span><span class="p">,</span>
      <span class="n">description</span> <span class="p">=</span> <span class="s">"sample string argument"</span><span class="p">,</span>
      <span class="n">required</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="nc">CliOption</span><span class="p">(</span>
      <span class="n">optionName</span> <span class="p">=</span> <span class="nc">OPTION_FILE</span><span class="p">,</span>
      <span class="n">valueDescription</span> <span class="p">=</span> <span class="s">"file"</span><span class="p">,</span>
      <span class="n">description</span> <span class="p">=</span> <span class="s">"sample file argument"</span><span class="p">,</span>
      <span class="n">required</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">processOption</span><span class="p">(</span>
    <span class="n">option</span><span class="p">:</span> <span class="nc">AbstractCliOption</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="nc">CompilerConfiguration</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">optionName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nc">OPTION_STRING</span> <span class="p">-&gt;</span> <span class="n">configuration</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">ARG_STRING</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="nc">OPTION_FILE</span> <span class="p">-&gt;</span> <span class="n">configuration</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">ARG_FILE</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">throw</span> <span class="nc">IllegalArgumentException</span><span class="p">(</span><span class="s">"Unexpected config option ${option.optionName}"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin/src/main/kotlin/com/bnorm/template/TemplateComponentRegistrar.kt"><code class="language-plaintext highlighter-rouge">ComponentRegistrar</code></a> is where the actual work of a compiler plugin actually begins. The registrar is responsible for registering extension components with the project being compiled. There are a number of extension points currently available in the Kotlin compiler, but the one we will be focusing on is <code class="language-plaintext highlighter-rouge">IrGenerationExtension</code>, which allows for navigating and transforming Kotlin IR.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoService</span><span class="p">(</span><span class="nc">ComponentRegistrar</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">TemplateComponentRegistrar</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">defaultString</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">defaultFile</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ComponentRegistrar</span> <span class="p">{</span>

  <span class="nd">@Suppress</span><span class="p">(</span><span class="s">"unused"</span><span class="p">)</span> <span class="c1">// Used by service loader</span>
  <span class="k">constructor</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span>
    <span class="n">defaultString</span> <span class="p">=</span> <span class="s">"Hello, World!"</span><span class="p">,</span>
    <span class="n">defaultFile</span> <span class="p">=</span> <span class="s">"file.txt"</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">registerProjectComponents</span><span class="p">(</span>
    <span class="n">project</span><span class="p">:</span> <span class="nc">MockProject</span><span class="p">,</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="nc">CompilerConfiguration</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">messageCollector</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">CLIConfigurationKeys</span><span class="p">.</span><span class="nc">MESSAGE_COLLECTOR_KEY</span><span class="p">,</span> <span class="nc">MessageCollector</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">string</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">TemplateCommandLineProcessor</span><span class="p">.</span><span class="nc">ARG_STRING</span><span class="p">,</span> <span class="n">defaultString</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">file</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">TemplateCommandLineProcessor</span><span class="p">.</span><span class="nc">ARG_FILE</span><span class="p">,</span> <span class="n">defaultFile</span><span class="p">)</span>

    <span class="nc">IrGenerationExtension</span><span class="p">.</span><span class="nf">registerExtension</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nc">TemplateIrGenerationExtension</span><span class="p">(</span><span class="n">messageCollector</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>An instance of <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin/src/main/kotlin/com/bnorm/template/TemplateIrGenerationExtension.kt"><code class="language-plaintext highlighter-rouge">IrGenerationExtension</code></a> can be created and registered within a <code class="language-plaintext highlighter-rouge">ComponentRegistrar</code>. This instance will be called during compilation when IR code needs to be generated (or transformed). The entry point for this extension provides an <code class="language-plaintext highlighter-rouge">IrModuleFragment</code> and <code class="language-plaintext highlighter-rouge">IrPluginContext</code> which provide everything we need to navigate and transform the module IR code.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TemplateIrGenerationExtension</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">messageCollector</span><span class="p">:</span> <span class="nc">MessageCollector</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">string</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">file</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">IrGenerationExtension</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">generate</span><span class="p">(</span><span class="n">moduleFragment</span><span class="p">:</span> <span class="nc">IrModuleFragment</span><span class="p">,</span> <span class="n">pluginContext</span><span class="p">:</span> <span class="nc">IrPluginContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">messageCollector</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="nc">CompilerMessageSeverity</span><span class="p">.</span><span class="nc">INFO</span><span class="p">,</span> <span class="s">"Argument 'string' = $string"</span><span class="p">)</span>
    <span class="n">messageCollector</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="nc">CompilerMessageSeverity</span><span class="p">.</span><span class="nc">INFO</span><span class="p">,</span> <span class="s">"Argument 'file' = $file"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>We‚Äôll be going more into how to use the provided <code class="language-plaintext highlighter-rouge">IrModuleFragment</code> and <code class="language-plaintext highlighter-rouge">IrPluginContext</code> values in the next parts of this series. But next we need to talk about how Kotlin/Native is different.</p> <h1 id="kotlin-plugin---native">Kotlin Plugin - Native</h1> <p>You may have noticed that the Gradle plugin defines a separate coordinate for the Kotlin/Native compiler plugin artifact. This is because Kotlin/Native compiler plugins are compiled with a different dependency than other compiler plugins. <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin-native/build.gradle.kts">Kotlin/Native compiler plugins</a> use the <code class="language-plaintext highlighter-rouge">org.jetbrains.kotlin:kotlin-compiler</code> artifact while <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin/build.gradle.kts">plugins for every other platform</a> use the <code class="language-plaintext highlighter-rouge">org.jetbrains.kotlin:kotlin-compiler-embedded</code> artifact.</p> <p>The only difference I have found between these artifacts is the embedded artifact shadows some classes so their package is different. Other then that, the code between these plugins can be exactly the same. To share code, I use <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin-native/build.gradle.kts#L16-L27">Gradle to copy the code</a> of the non-Kotlin/Native compiler plugin over to the Kotlin/Native compiler plugin module and change the import statements as required.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tasks</span><span class="p">.</span><span class="nf">named</span><span class="p">(</span><span class="s">"compileKotlin"</span><span class="p">)</span> <span class="p">{</span> <span class="nf">dependsOn</span><span class="p">(</span><span class="s">"syncSource"</span><span class="p">)</span> <span class="p">}</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">register</span><span class="p">&lt;</span><span class="nc">Sync</span><span class="p">&gt;(</span><span class="s">"syncSource"</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">from</span><span class="p">(</span><span class="nf">project</span><span class="p">(</span><span class="s">":kotlin-ir-plugin"</span><span class="p">).</span><span class="n">sourceSets</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">get</span><span class="p">().</span><span class="n">allSource</span><span class="p">)</span>
  <span class="nf">into</span><span class="p">(</span><span class="s">"src/main/kotlin"</span><span class="p">)</span>
  <span class="nf">filter</span> <span class="p">{</span>
    <span class="c1">// Replace shadowed imports from plugin module</span>
    <span class="k">when</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
      <span class="s">"import org.jetbrains.kotlin.com.intellij.mock.MockProject"</span> <span class="p">-&gt;</span> <span class="s">"import com.intellij.mock.MockProject"</span>
      <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">it</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>This isn‚Äôt ideal, but I‚Äôm sure this oddity will be resolved as Kotlin/Native and compiler plugins mature.</p> <h1 id="kotlin-plugin---testing">Kotlin Plugin - Testing</h1> <p>Testing Kotlin/JVM compiler plugins is really easy thanks to the <a href="https://github.com/tschuchortdev/kotlin-compile-testing"><code class="language-plaintext highlighter-rouge">kotlin-compile-testing</code></a> library! This library allows you to <a href="https://github.com/bnorm/kotlin-ir-plugin-template/blob/medium-part1/kotlin-ir-plugin/src/test/kotlin/com/bnorm/template/IrPluginTest.kt">compile Kotlin source strings</a> with your ComponentRegistrar in tests which makes debugging easy. The resulting compiled files can even be loaded via a ClassLoader if you want to execute them which we will discuss later.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">IrPluginTest</span> <span class="p">{</span>
  <span class="nd">@Test</span>
  <span class="k">fun</span> <span class="nf">`IR</span> <span class="n">plugin</span> <span class="nf">success`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">compile</span><span class="p">(</span>
      <span class="n">sourceFile</span> <span class="p">=</span> <span class="nc">SourceFile</span><span class="p">.</span><span class="nf">kotlin</span><span class="p">(</span>
        <span class="s">"main.kt"</span><span class="p">,</span> <span class="s">"""
fun main() {
  println(debug())
}
fun debug() = "Hello, World!"
"""</span>
      <span class="p">)</span>
    <span class="p">)</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">KotlinCompilation</span><span class="p">.</span><span class="nc">ExitCode</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">exitCode</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">compile</span><span class="p">(</span>
  <span class="n">sourceFiles</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">SourceFile</span><span class="p">&gt;,</span>
  <span class="n">plugin</span><span class="p">:</span> <span class="nc">ComponentRegistrar</span> <span class="p">=</span> <span class="nc">TemplateComponentRegistrar</span><span class="p">(),</span>
<span class="p">):</span> <span class="nc">KotlinCompilation</span><span class="p">.</span><span class="nc">Result</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">KotlinCompilation</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="n">sources</span> <span class="p">=</span> <span class="n">sourceFiles</span>
    <span class="n">useIR</span> <span class="p">=</span> <span class="k">true</span>
    <span class="n">compilerPlugins</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
    <span class="n">inheritClassPath</span> <span class="p">=</span> <span class="k">true</span>
  <span class="p">}.</span><span class="nf">compile</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">compile</span><span class="p">(</span>
  <span class="n">sourceFile</span><span class="p">:</span> <span class="nc">SourceFile</span><span class="p">,</span>
  <span class="n">plugin</span><span class="p">:</span> <span class="nc">ComponentRegistrar</span> <span class="p">=</span> <span class="nc">TemplateComponentRegistrar</span><span class="p">(),</span>
<span class="p">):</span> <span class="nc">KotlinCompilation</span><span class="p">.</span><span class="nc">Result</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">compile</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="n">sourceFile</span><span class="p">),</span> <span class="n">plugin</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>If you execute the tests you should see the following output present in the log.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i: Argument 'string' = Hello, World!
i: Argument 'file' = file.txt
</code></pre></div></div> <hr /> <p>And with that, congrats! You now know how to set up a Kotlin compiler plugin project and are ready to start navigating and transforming IR code! If you want to avoid the manual work of setting all of this up, you can use the <a href="https://github.com/bnorm/kotlin-ir-plugin-template">GitHub template</a> I created when writing this article.</p> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">I&#39;m embarking on a blog series showing how to build a Kotlin IR compiler plugin, join me for part 1! üß© Hoping to release a new part each week. <a href="https://t.co/qsKhIy6M3O">https://t.co/qsKhIy6M3O</a></p>&mdash; Brian Norman üê¢ (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1330241400391262209?ref_src=twsrc%5Etfw">November 21, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/soft-assertion-with-kotlin-power-assert" title="PREV: Soft Assertion with kotlin-power-assert">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2020 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
