<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Soft Assertion with kotlin-power-assert · Dev Blog by Brian</title> <meta name="description" content="The kotlin-power-assert Kotlin compiler plugin is great (I may be biased asits author) as it enables diagramming of assert function calls. As the plugin grow..."> <link rel="icon" href="https://blog.bnorm.dev/assets/favicon.png"> <link rel="apple-touch-icon" href="https://blog.bnorm.dev/assets/touch-icon.png"> <link rel="stylesheet" href="https://blog.bnorm.dev/assets/core.css"> <link rel="canonical" href="https://blog.bnorm.dev/soft-assertion-with-kotlin-power-assert"> <link rel="alternate" type="application/atom+xml" title="Dev Blog by Brian" href="https://blog.bnorm.dev/feed.xml" /> <!-- Twitter cards metadatas --> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@bnormcodes"> <meta name="twitter:creator" content="@bnormcodes"> <meta name="twitter:title" content="Soft Assertion with kotlin-power-assert"> <meta name="twitter:url" content="https://blog.bnorm.dev/soft-assertion-with-kotlin-power-assert"> <meta name="twitter:description" content="Dev blog by Brian"> <!-- Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SH69BHV31K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SH69BHV31K'); </script> </head> <body> <div class="header"> <aside class="logo"> <a href="https://blog.bnorm.dev/"> <img src="https://avatars2.githubusercontent.com/u/1074449?v=4" alt="" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <div class="social-media-list"> <div> <a href="https://github.com/bnorm"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> bnorm</a> </div> <div> <a href="https://www.twitter.com/bnormcodes"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> bnormcodes</a> </div> </div> </div> <div id="content"> <article> <div class="center"> <h1 class="title">Soft Assertion with kotlin-power-assert</h1> <time class="code">September 28, 2020</time> </div> <div class="divider"></div> <p>The <a href="https://github.com/bnorm/kotlin-power-assert"><code class="language-plaintext highlighter-rouge">kotlin-power-assert</code></a> Kotlin compiler plugin is great (I may be biased as its author) as it enables diagramming of assert function calls. As the plugin grows and matures I’m discovering new use cases. One I wanted to try is the idea of soft assertions which <a href="https://joel-costigliola.github.io/assertj/core/api/org/assertj/core/api/SoftAssertions.html">many</a> <a href="http://spockframework.org/spock/docs/1.2-RC3/all_in_one.html#_using_code_verifyall_code_to_assert_multiple_expectations_together">assertion</a> <a href="http://spockframework.org/spock/docs/1.2-RC3/all_in_one.html#_using_code_verifyall_code_to_assert_multiple_expectations_together">libraries</a> <a href="https://truth.dev/api/latest/com/google/common/truth/Expect.html">support</a>. Let’s take a look quickly at an example of <code class="language-plaintext highlighter-rouge">verifyAll</code> from the <a href="http://spockframework.org/">Spock Framework</a>.</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">def</span> <span class="s2">"offered PC matches preferred configuration"</span><span class="o">()</span> <span class="o">{</span>
  <span class="nl">when:</span>
  <span class="kt">def</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">shop</span><span class="o">.</span><span class="na">buyPc</span><span class="o">()</span>

  <span class="nl">then:</span>
  <span class="n">verifyAll</span><span class="o">(</span><span class="n">pc</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">vendor</span> <span class="o">==</span> <span class="s2">"Sunny"</span>
    <span class="n">clockRate</span> <span class="o">&gt;=</span> <span class="mi">2333</span>
    <span class="n">ram</span> <span class="o">&gt;=</span> <span class="mi">406</span>
    <span class="n">os</span> <span class="o">==</span> <span class="s2">"Linux"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>The example above is straight from the documentation and demonstrates verifying multiple properties of a class at a single time. The nice thing here is that all failures will be reported, not just the first one. This avoids needing to run the test multiple times, discovering the next failed property after fixing the previous failed property. The <code class="language-plaintext highlighter-rouge">verifyAll</code> function gathers each failed assertion and only throws an exception when the scope closes.</p> <h1 id="complex-boolean-expressions">Complex Boolean Expressions</h1> <p><code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> allows complex boolean expressions to be diagramed but this requires support for <a href="https://en.wikipedia.org/wiki/Short-circuit_evaluation">short-circuiting</a>. This is because smart casting allows some interesting boolean expressions like the following.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert</span><span class="p">(</span><span class="n">jane</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">jane</span><span class="p">.</span><span class="n">firstName</span> <span class="p">==</span> <span class="s">"Jane"</span><span class="p">)</span>

<span class="err">#</span> <span class="nc">Example</span> <span class="n">failure</span>
<span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="nc">AssertionError</span><span class="p">:</span> <span class="nc">Assertion</span> <span class="n">failed</span>
<span class="nf">assert</span><span class="p">(</span><span class="n">jane</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">jane</span><span class="p">.</span><span class="n">firstName</span> <span class="p">==</span> <span class="s">"Jane"</span><span class="p">)</span>
       <span class="p">|</span>    <span class="p">|</span>
       <span class="p">|</span>    <span class="k">false</span>
       <span class="k">null</span>
</code></pre></div></div> <p>So if multiple properties of a class are included as a single boolean expression, <code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> will only diagram up to the first failure.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">assert</span><span class="p">(</span><span class="n">jane</span><span class="p">.</span><span class="n">firstName</span> <span class="p">==</span> <span class="s">"Jane"</span> <span class="p">&amp;&amp;</span> <span class="n">jane</span><span class="p">.</span><span class="n">lastName</span> <span class="p">==</span> <span class="s">"Doe"</span><span class="p">)</span>

<span class="err">#</span> <span class="nc">Example</span> <span class="n">failure</span>
<span class="nf">assert</span><span class="p">(</span><span class="n">jane</span><span class="p">.</span><span class="n">firstName</span> <span class="p">==</span> <span class="s">"Jane"</span> <span class="p">&amp;&amp;</span> <span class="n">jane</span><span class="p">.</span><span class="n">lastName</span> <span class="p">==</span> <span class="s">"Doe"</span><span class="p">)</span>
       <span class="p">|</span>    <span class="p">|</span>         <span class="p">|</span>
       <span class="p">|</span>    <span class="p">|</span>         <span class="k">false</span>
       <span class="p">|</span>    <span class="nc">John</span>
       <span class="nc">Person</span><span class="err">@</span><span class="mi">765</span><span class="n">cb1b3</span>
</code></pre></div></div> <p>If the <code class="language-plaintext highlighter-rouge">Person</code> class had a better <code class="language-plaintext highlighter-rouge">toString()</code> function or was a data class that might solve this specific problem, but this exposes a general problem that needs solving.</p> <h1 id="scoped-assertion">Scoped Assertion</h1> <p>Creating something similar to Spock’s <code class="language-plaintext highlighter-rouge">verifyAll</code> with Kotlin and the <code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> compiler plugin is very simple and only takes a few dozen lines of code. Kotlin supports the same higher-order function syntax as Groovy and <code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> adds diagrammed assertion support. Here’s all it takes:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typealias</span> <span class="nc">LazyMessage</span> <span class="p">=</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Any</span>

<span class="kd">interface</span> <span class="nc">AssertScope</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">assert</span><span class="p">(</span><span class="n">assertion</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span> <span class="n">lazyMessage</span><span class="p">:</span> <span class="nc">LazyMessage</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kd">class</span> <span class="nc">SoftAssertScope</span> <span class="p">:</span> <span class="nc">AssertScope</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">assertions</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Throwable</span><span class="p">&gt;()</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">assert</span><span class="p">(</span><span class="n">assertion</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span> <span class="n">lazyMessage</span><span class="p">:</span> <span class="nc">LazyMessage</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">assertion</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assertions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">AssertionError</span><span class="p">(</span><span class="n">lazyMessage</span><span class="o">?.</span><span class="nf">invoke</span><span class="p">()</span><span class="o">?.</span><span class="nf">toString</span><span class="p">()))</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">close</span><span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">assertions</span><span class="p">.</span><span class="nf">isNotEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">base</span> <span class="p">=</span> <span class="n">exception</span> <span class="o">?:</span> <span class="nc">AssertionError</span><span class="p">(</span><span class="s">"Multiple failed assertions"</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">assertion</span> <span class="k">in</span> <span class="n">assertions</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">addSuppressed</span><span class="p">(</span><span class="n">assertion</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="n">base</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">R</span><span class="p">&gt;</span> <span class="nf">assertSoftly</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="nc">AssertScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="nc">R</span><span class="p">):</span> <span class="nc">R</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="nc">SoftAssertScope</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">runCatching</span> <span class="p">{</span> <span class="n">scope</span><span class="p">.</span><span class="nf">block</span><span class="p">()</span> <span class="p">}</span>
  <span class="n">scope</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">exceptionOrNull</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">getOrThrow</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>A <a href="https://github.com/bnorm/kotlin-power-assert/blob/v0.5.3/sample/src/commonMain/kotlin/com/bnorm/power/AssertScope.kt">sample</a> of this was added to the <code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> library in version 0.5.3 which fixed a bug when transforming member functions. Now you can write the following in your test!</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">jane</span><span class="p">:</span> <span class="nc">Person</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
<span class="nf">assertSoftly</span> <span class="p">{</span>
  <span class="nf">assert</span><span class="p">(</span><span class="n">jane</span><span class="p">.</span><span class="n">firstName</span> <span class="p">==</span> <span class="s">"Jane"</span><span class="p">)</span>
  <span class="nf">assert</span><span class="p">(</span><span class="n">jane</span><span class="p">.</span><span class="n">lastName</span> <span class="p">==</span> <span class="s">"Doe"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <hr /> <p>Soft assertions can help pin point all failures with a single test run. <code class="language-plaintext highlighter-rouge">kotlin-power-assert</code> can help diagram those failures and make them easier to triage. Give them both a try and see how they work for you!</p> <div class="center"> <div class="divider"></div> <span>Join the conversation!</span> <div class='jekyll-twitter-plugin'><blockquote class="twitter-tweet" align="center"><p lang="en" dir="ltr">Fixed a few bugs in kotlin-power-assert version 0.5.3 after messing around with a small soft assertion DSL. 🍦 <a href="https://t.co/zhhoI6NYox">https://t.co/zhhoI6NYox</a></p>&mdash; Brian Norman 🐢 (@bnormcodes) <a href="https://twitter.com/bnormcodes/status/1310759111382966275?ref_src=twsrc%5Etfw">September 29, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> </div> <!-- reddit? --> </div> </article> <div class="page-navigation code"> <a class="next" href="https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1" title="NEXT: Writing Your Second Kotlin Compiler Plugin, Part 1 — Project Setup">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="https://blog.bnorm.dev/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="https://blog.bnorm.dev/reac-functional-components-with-kotlinjs" title="PREV: React Functional Components with Kotlin/JS">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&copy; 2020 Brian Norman</span> <span class="block"><small>&lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/the-plain">The Plain theme</a>.</small></span> </div> </body> </html>
